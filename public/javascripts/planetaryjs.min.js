/** 
* @license planetary-twitter - v0.0.1
* (c) 2013 Julien VALERY https://github.com/darul75/ng-prettyjson
* License: MIT 
**/
/*! Planetary.js v1.0.1
 *  Copyright (c) 2013 Brandon Tilley
 *
 *  Released under the MIT license
 *  Date: 2014-01-02T17:05:08.541Z
 */
!function(a,b){"function"==typeof define&&define.amd?define(["d3","topojson"],b):"object"==typeof exports?module.exports=b(require("d3"),require("topojson")):a.planetaryjs=b(a.d3,a.topojson,a)}(this,function(a,b,c){"use strict";var d=null;c&&(d=c.planetaryjs);var e=[],f=function(b,c,d){a.timer(function(){b.context.clearRect(0,0,c.width,c.height);for(var a=0;a<d.onDraw.length;a++)d.onDraw[a]()})},g=function(a,b){for(var c=e.length-1;c>=0;c--)b.unshift(e[c]);for(0===b.length&&(j.plugins.earth&&a.loadPlugin(j.plugins.earth()),j.plugins.pings&&a.loadPlugin(j.plugins.pings())),c=0;c<b.length;c++)b[c](a)},h=function(a,b,c){if(c.onInit.length){var d=0,e=function(a){var b=c.onInit[d];b.length?b(function(){d++,a()}):(b(),d++,setTimeout(a,0))},g=function(){d>=c.onInit.length?f(a,b,c):e(g)};e(g)}else f(a,b,c)},i=function(a,b,c,d){g(a,c),a.canvas=b,a.context=b.getContext("2d"),h(a,b,d)},j={plugins:{},noConflict:function(){return c.planetaryjs=d,j},loadPlugin:function(a){e.push(a)},planet:function(){var b=[],c={onInit:[],onDraw:[]},d={plugins:{},draw:function(a){i(d,a,b,c)},onInit:function(a){c.onInit.push(a)},onDraw:function(a){c.onDraw.push(a)},loadPlugin:function(a){b.push(a)},withSavedContext:function(a){if(!this.context)throw new Error("No canvas to fetch context for");this.context.save(),a(this.context),this.context.restore()}};return d.projection=a.geo.orthographic().clipAngle(90).precision(0),d.path=a.geo.path().projection(d.projection),d}};return j.plugins.topojson=function(b){return function(c){c.plugins.topojson={},c.onInit(function(d){if(b.world)c.plugins.topojson.world=b.world,setTimeout(d,0);else{var e=b.file||"world-110m.json";a.json(e,function(a,b){if(a)throw new Error("Could not load JSON "+e);c.plugins.topojson.world=b,d()})}})}},j.plugins.oceans=function(a){return function(b){b.onDraw(function(){b.withSavedContext(function(c){c.beginPath(),b.path.context(c)({type:"Sphere"});var d=b.projection.scale(),e=b.projection.scale(),f=d-20,g=e,h=c.createRadialGradient(d,e,f,d,e,g);h.addColorStop(0,a.fill),h.addColorStop(1,"white"),c.fillStyle=h,c.fill()})})}},j.plugins.land=function(a){return function(c){var d=null;c.onInit(function(){var a=c.plugins.topojson.world;d=b.feature(a,a.objects.land)}),c.onDraw(function(){c.withSavedContext(function(b){b.beginPath(),b.shadowOffsetX=1,b.shadowOffsetY=1,b.shadowColor="white",c.path.context(b)(d),a.fill!==!1&&(b.fillStyle=a.fill||"white",b.fill()),a.stroke&&(a.lineWidth&&(b.lineWidth=a.lineWidth),b.strokeStyle=a.stroke,b.stroke())})})}},j.plugins.borders=function(a){return function(c){var d=null,e={internal:function(a,b){return a.id!==b.id},external:function(a,b){return a.id===b.id},both:function(){return!0}};c.onInit(function(){var f=c.plugins.topojson.world,g=f.objects.countries,h=a.type||"internal";d=b.mesh(f,g,e[h])}),c.onDraw(function(){c.withSavedContext(function(b){b.beginPath(),c.path.context(b)(d),b.strokeStyle=a.stroke||"gray",a.lineWidth&&(b.lineWidth=a.lineWidth),b.stroke()})})}},j.plugins.earth=function(a){a=a||{};var b=a.topojson||{},c=a.oceans||{},d=a.land||{},e=a.borders||{};return function(a){j.plugins.topojson(b)(a),j.plugins.oceans(c)(a),j.plugins.land(d)(a),j.plugins.borders(e)(a)}},j.plugins.pings=function(b){var c=[];b=b||{};var d=function(a,d,e){e=e||{},e.color=e.color||b.color||"white",e.angle=e.angle||b.angle||5,e.ttl=e.ttl||b.ttl||2e3;var f={time:new Date,options:e};b.latitudeFirst?(f.lat=a,f.lng=d):(f.lng=a,f.lat=d),c.push(f)},e=function(a,b,d){for(var e=[],g=0;g<c.length;g++){var h=c[g],i=d-h.time;i<h.options.ttl&&(e.push(h),f(a,b,d,i,h))}c=e},f=function(b,c,d,e,f){var g=(1-e/f.options.ttl,a.rgb(f.options.color));g="rgba("+g.r+","+g.g+","+g.b+",0.3)",c.strokeStyle=g;var h=a.geo.circle().origin([f.lng,f.lat]).angle(e/f.options.ttl*f.options.angle)();c.beginPath(),b.path.context(c)(h),c.stroke()};return function(a){a.plugins.pings={add:d},a.onDraw(function(){var b=new Date;a.withSavedContext(function(c){e(a,c,b)})})}},j.plugins.zoom=function(b){b=b||{};var c=function(){},d=b.onZoomStart||c,e=b.onZoomEnd||c,f=b.onZoom||c,g=b.afterZoom||c,h=b.initialScale,i=b.scaleExtent||[50,2e3];return function(b){b.onInit(function(){var c=a.behavior.zoom().scaleExtent(i);null!==h&&void 0!==h?c.scale(h):c.scale(b.projection.scale()),c.on("zoomstart",d.bind(b)).on("zoomend",e.bind(b)).on("zoom",function(){f.call(b),b.projection.scale(a.event.scale),g.call(b)}),a.select(b.canvas).call(c)})}},j.plugins.drag=function(b){b=b||{};var c=function(){},d=b.onDragStart||c,e=b.onDragEnd||c,f=b.onDrag||c,g=b.afterDrag||c;return function(b){b.onInit(function(){var c=a.behavior.drag().on("dragstart",d.bind(b)).on("dragend",e.bind(b)).on("drag",function(){f.call(b);var c=a.event.dx,d=a.event.dy,e=b.projection.rotate(),h=b.projection.scale(),i=a.scale.linear().domain([-1*h,h]).range([-90,90]),j=i(c),k=i(d);e[0]+=j,e[1]-=k,e[1]>90&&(e[1]=90),e[1]<-90&&(e[1]=-90),e[0]>=180&&(e[0]-=360),b.projection.rotate(e),g.call(b)});a.select(b.canvas).call(c)})}},j});