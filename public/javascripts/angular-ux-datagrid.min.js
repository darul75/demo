/*
* uxDatagrid v.1.0.0
* (c) 2014, WebUX
* https://github.com/webux/ux-angularjs-datagrid
* License: MIT.
*/
(function(exports, global){
function charPack(char,amount){for(var str="";str.length<amount;)str+=char;return str}function each(list,method){var len,result,extraArgs,i=0;if(arguments.length>2&&(extraArgs=exports.util.array.toArray(arguments),extraArgs.splice(0,2)),list&&list.length)for(len=list.length;len>i;){if(result=method.apply(null,[list[i],i,list].concat(extraArgs)),void 0!==result)return result;i+=1}else if(list.hasOwnProperty("0"))for(;list.hasOwnProperty(i);){if(result=method.apply(null,[list[i],i,list].concat(extraArgs)),void 0!==result)return result;i+=1}else if(!(list instanceof Array))for(i in list)if(list.hasOwnProperty(i)&&(result=method.apply(null,[list[i],i,list].concat(extraArgs)),void 0!==result))return result;return list}function filter(list,method){var len,extraArgs,response,i=0,result=[];if(arguments.length>2&&(extraArgs=exports.util.array.toArray(arguments),extraArgs.splice(0,2)),list&&list.length)for(len=list.length;len>i;)response=method.apply(null,[list[i],i,list].concat(extraArgs)),response&&result.push(list[i]),i+=1;else for(i in list)list.hasOwnProperty(i)&&(response=method.apply(null,[list[i],i,list].concat(extraArgs)),response&&result.push(list[i]));return result}function dispatcher(target,scope,map){function off(event,callback){var index,list;list=listeners[event],list&&(callback?(index=list.indexOf(callback),-1!==index&&list.splice(index,1)):list.length=0)}function on(event,callback){return listeners[event]=listeners[event]||[],listeners[event].push(callback),function(){off(event,callback)}}function onOnce(event,callback){function fn(){off(event,fn),callback.apply(scope||target,arguments)}return on(event,fn)}function getListeners(event){return listeners[event]}function fire(callback,args){return callback&&callback.apply(target,args)}function dispatch(event){if(listeners[event])for(var i=0,list=listeners[event],len=list.length;len>i;)fire(list[i],arguments),i+=1}var listeners={};scope&&map?(target.on=scope[map.on]&&scope[map.on].bind(scope),target.off=scope[map.off]&&scope[map.off].bind(scope),target.onOnce=scope[map.onOnce]&&scope[map.onOnce].bind(scope),target.dispatch=scope[map.dispatch].bind(scope)):(target.on=on,target.off=off,target.onOnce=onOnce,target.dispatch=dispatch),target.getListeners=getListeners}function extend(destination){for(var item,j,args=exports.util.array.toArray(arguments),i=1,len=args.length;len>i;){item=args[i];for(j in item)destination[j]=destination[j]&&"object"==typeof destination[j]?extend(destination[j],item[j]):item[j]instanceof Array?extend([],item[j]):item[j]&&"object"==typeof item[j]?extend({},item[j]):item[j];i+=1}return destination}function toArray(obj){var result=[],i=0,len=obj.length;if(void 0!==obj.length)for(;len>i;)result.push(obj[i]),i+=1;else for(i in obj)obj.hasOwnProperty(i)&&result.push(obj[i]);return result}function sort(ary,compareFn){var c,len,v,rlen,holder;for(compareFn||(compareFn=function(a,b){return a>b?1:b>a?-1:0}),len=ary.length,rlen=len-1,c=0;len>c;c+=1)for(v=0;rlen>v;v+=1)compareFn(ary[v],ary[v+1])>0&&(holder=ary[v+1],ary[v+1]=ary[v],ary[v]=holder);return ary}function Flow(inst,dispatch){function getMethodName(method){return method.toString().split(/\b/)[2]}function createItem(method,args,delay){return{label:getMethodName(method),method:method,args:args||[],delay:delay}}function unique(method){var name=getMethodName(method);uniqueMethods[name]=method}function clearSimilarItemsFromList(item){for(var i=0,len=list.length;len>i;)list[i].label===item.label&&list[i]!==current&&(inst.log("clear duplicate item %c%s",consoleMethodStyle,item.label),list.splice(i,1),i-=1,len-=1),i+=1}function add(method,args,delay){var item=createItem(method,args,delay);uniqueMethods[item.label]&&clearSimilarItemsFromList(item),list.push(item),running&&next()}function insert(method,args,delay){list.splice(1,0,createItem(method,args,delay))}function remove(method){clearSimilarItemsFromList({label:getMethodName(method)})}function timeout(method,time){var intv,item=createItem(method,[],time),startTime=Date.now(),timeoutCall=function(){inst.log("exec timeout method %c%s %sms",consoleMethodStyle,item.label,Date.now()-startTime),method()};return inst.log("wait for timeout method %c%s",consoleMethodStyle,item.label),intv=setTimeout(timeoutCall,time),timeouts[intv]=function(){clearTimeout(intv),delete timeouts[intv]},intv}function stopTimeout(intv){timeouts[intv]&&timeouts[intv]()}function getArguments(fn){var str=fn.toString(),match=str.match(/\(.*\)/);return match[0].match(/([\$\w])+/gm)}function hasDoneArg(fn){var args=getArguments(fn);return!(!args||-1===args.indexOf("done"))}function done(){return execEndTime=Date.now(),inst.log("finish %c%s took %dms",consoleMethodStyle,current.label,execEndTime-execStartTime),current=null,addToHistory(list.shift()),list.length&&next(),execEndTime-execStartTime}function addToHistory(item){for(history.unshift(item);history.length>historyLimit;)history.pop()}function next(){!current&&list.length&&(current=list[0],inst.async&&void 0!==current.delay?(inst.log("	delay for %c%s %sms",consoleMethodStyle,current.label,current.delay),clearTimeout(intv),intv=setTimeout(exec,current.delay)):exec())}function exec(){inst.log("start method %c%s",consoleMethodStyle,current.label);var methodHasDoneArg=hasDoneArg(current.method);methodHasDoneArg&&current.args.push(done),execStartTime=Date.now(),current.method.apply(null,current.args),methodHasDoneArg||done()}function run(){running=!0,next()}function clear(){var item,len=current?1:0;for(inst.log("clear");list.length>len;)item=list.splice(len,1)[0],inst.log("	remove %s from flow",item.label)}function length(){return list.length}function destroy(){clearTimeout(intv),list.length=0,inst=null}var intv,execStartTime,execEndTime,running=!1,current=null,list=[],history=[],historyLimit=10,uniqueMethods={},timeouts={},consoleMethodStyle="color:#666666;";return inst=exports.logWrapper("Flow",inst||{},"grey",dispatch),inst.async=inst.hasOwnProperty("async")?inst.async:!0,inst.debug=inst.hasOwnProperty("debug")?inst.debug:0,inst.insert=insert,inst.add=add,inst.unique=unique,inst.remove=remove,inst.timeout=timeout,inst.stopTimeout=stopTimeout,inst.run=run,inst.clear=clear,inst.length=length,inst.destroy=destroy,inst}function Datagrid(scope,element,attr,$compile){function init(){flow.unique(reset),flow.unique(render),flow.unique(updateRowWatchers)}function setupExports(){inst.uid=exports.uid(),inst.name=scope.$eval(attr.gridName)||"datagrid",inst.scope=scope,inst.element=element,inst.attr=attr,inst.rowsLength=0,inst.scopes=scopes,inst.data=inst.data||[],inst.unwatchers=unwatchers,inst.values=values,inst.start=start,inst.update=update,inst.reset=reset,inst.isReady=isReady,inst.isStartupComplete=isStartupComplete,inst.forceRenderScope=forceRenderScope,inst.dispatch=dispatch,inst.activateScope=activateScope,inst.deactivateScope=deactivateScope,inst.render=function(){flow.add(render)},inst.updateHeights=updateHeights,inst.getOffsetIndex=getOffsetIndex,inst.isActive=isActive,inst.isCompiled=isCompiled,inst.swapItem=swapItem,inst.getScope=getScope,inst.getRowItem=getRowItem,inst.getRowElm=getRowElm,inst.getRowIndex=inst.getIndexOf=getRowIndex,inst.getRowOffset=getRowOffset,inst.getRowHeight=getRowHeight,inst.getViewportHeight=getViewportHeight,inst.getContentHeight=getContentHeight,inst.getContent=getContent,inst.safeDigest=safeDigest,inst.getRowIndexFromElement=getRowIndexFromElement,inst.updateViewportHeight=updateViewportHeight,inst.calculateViewportHeight=calculateViewportHeight,inst.options=options=exports.extend({},exports.datagrid.options,scope.$eval(attr.options)||{}),inst.flow=flow=new Flow({async:options.hasOwnProperty("async")?!!options.async:!0,debug:options.hasOwnProperty("debug")?options.debug:0},inst.dispatch),inst.grouped=scope.$eval(attr.grouped),inst.gc=forceGarbageCollection,flow.add(init),flow.run()}function createContent(){var cnt,contents=element[0].getElementsByClassName(options.contentClass),classes=options.contentClass;return contents=exports.filter(contents,filterOldContent),cnt=contents[0],cnt&&(classes=cnt.className||options.contentClass),cnt||(classes=getClassesFromOldContent()||classes,cnt=angular.element('<div class="'+classes+'"></div>'),inst.options.chunks.detachDom&&(cnt[0].style.position="relative"),element.prepend(cnt)),cnt[0]||(cnt=angular.element(cnt)),cnt}function getClassesFromOldContent(){var classes,index;return oldContent?(classes=exports.util.array.toArray(oldContent[0].classList),index=classes.indexOf("old-"+options.contentClass),-1!==index&&classes.splice(index,1),classes.join(" ")):void 0}function filterOldContent(cnt){return angular.element(cnt).hasClass("old-"+options.contentClass)?!1:!0}function getContent(){return content}function start(){inst.dispatch(exports.datagrid.events.ON_INIT),content=createContent(),waitForElementReady(0)}function waitForElementReady(count){if(!inst.element[0].offsetHeight){if(1>count)return flow.add(waitForElementReady,[count+1],0),void 0;flow.warn("Datagrid: Dom Element does not have a height.")}options.templateModel&&options.templateModel.templates&&flow.add(inst.templateModel.createTemplatesFromData,[options.templateModel.templates],0),flow.add(inst.templateModel.createTemplates,null,0),flow.add(function(){options.dynamicRowHeights=inst.templateModel.dynamicHeights()}),flow.add(addListeners)}function addListeners(){var unwatchFirstRender=scope.$on(exports.datagrid.events.ON_BEFORE_RENDER_AFTER_DATA_CHANGE,function(){unwatchFirstRender(),flow.add(onStartupComplete)});window.addEventListener("resize",onResize),unwatchers.push(scope.$on(exports.datagrid.events.UPDATE,update)),unwatchers.push(scope.$on(exports.datagrid.events.ON_ROW_TEMPLATE_CHANGE,onRowTemplateChange)),unwatchers.push(scope.$on("$destroy",destroy)),flow.add(setupChangeWatcher,[],0),inst.dispatch(exports.datagrid.events.ON_LISTENERS_READY)}function isStartupComplete(){return startupComplete}function onStartupComplete(){startupComplete=!0,dispatch(exports.datagrid.events.ON_STARTUP_COMPLETE)}function setupChangeWatcher(){if(!changeWatcherSet){inst.log("setupChangeWatcher"),changeWatcherSet=!0,unwatchers.push(scope.$watchCollection(attr.uxDatagrid,onDataChangeFromWatcher));var d=scope.$eval(attr.uxDatagrid);d&&d.length&&flow.add(render)}}function onDataChangeFromWatcher(newValue,oldValue){flow.add(onDataChanged,[newValue,oldValue])}function updateViewportHeight(){viewHeight=inst.calculateViewportHeight()}function isReady(){return state===states.READY}function calculateViewportHeight(){return element[0].offsetHeight}function onResize(){flow.add(updateHeights,[],100)}function swapItem(oldItem,newItem,keepTemplate){var oldTpl,newTpl,index=getRowIndex(oldItem);inst.data.hasOwnProperty(index)&&(oldTpl=inst.templateModel.getTemplate(oldItem),newTpl=keepTemplate?oldTpl:inst.templateModel.getTemplate(newItem),inst.normalizeModel.replace(newItem,index),oldTpl!==newTpl?inst.templateModel.setTemplate(index,newTpl):(scopes[index][newTpl.item]=newItem,safeDigest(scopes[index])))}function getScope(index){return scopes[index]}function getRowItem(index){return this.getData()[index]}function getRowElm(index){return angular.element(inst.chunkModel.getRow(index))}function isCompiled(index){return!!scopes[index]}function getRowIndex(item){return inst.getNormalizedIndex(item,0)}function getRowIndexFromElement(el){if(element[0].contains(el[0]||el)){el=el.scope?el:angular.element(el);var s=el.scope();if(s===inst.scope)throw new Error("Unable to get row scope... something went wrong.");for(;s&&s.$parent&&s.$parent!==inst.scope;)s=s.$parent;return s.$index}return-1}function getRowOffset(index){return void 0===rowOffsets[index]&&(options.dynamicRowHeights?updateHeightValues():rowOffsets[index]=index*options.rowHeight),rowOffsets[index]}function getRowHeight(index){return inst.templateModel.getTemplateHeight(inst.data[index])}function getViewportHeight(){return viewHeight}function getContentHeight(){var list=inst.chunkModel.getChunkList();return list&&list.height||0}function createDom(list){inst.log("OVERWRITE DOM!!!");var len=list.length;inst.chunkModel.chunkDom(list,options.chunks.size,'<div class="'+options.chunks.chunkClass+'">',"</div>",content),inst.rowsLength=len,inst.log("created %s dom elements",len)}function compileRow(index){var prev,tpl,el,s=scopes[index];return s||(s=scope.$new(),prev=getScope(index-1),tpl=inst.templateModel.getTemplate(inst.data[index]),prev&&(prev.$$nextSibling=s,s.$$prevSibling=prev),s.$status=options.compiledClass,s[tpl.item]=inst.data[index],s.$index=index,scopes[index]=s,el=getRowElm(index),el.removeClass(options.uncompiledClass),$compile(el)(s),inst.dispatch(exports.datagrid.events.ON_ROW_COMPILE,s,el),deactivateScope(s)),s}function buildRows(list,forceRender){inst.log("	buildRows %s",list.length),state=states.BUILDING,createDom(list),flow.add(updateHeightValues,0),isReady()||flow.add(ready),forceRender&&flow.add(render)}function ready(){inst.log("	ready"),state=states.READY,flow.add(fireReadyEvent),flow.add(safeDigest,[scope])}function fireReadyEvent(){scope.$emit(exports.datagrid.events.ON_READY)}function safeDigest(s){for(var ds=s;ds;){if(ds.$$phase)return;ds=ds.$parent}s.$digest()}function applyEventCounts(s,listenerCounts,fn){for(;s;){for(var eventName in listenerCounts)listenerCounts.hasOwnProperty(eventName)&&fn(s,listenerCounts,eventName);s=s.$parent}}function addEvents(s,listenerCounts){applyEventCounts(s,listenerCounts,addEvent)}function addEvent(s,listenerCounts,eventName){s.$$listenerCount[eventName]+=listenerCounts[eventName]}function subtractEvents(s,listenerCounts){applyEventCounts(s,listenerCounts,subtractEvent)}function subtractEvent(s,listenerCounts,eventName){s.$$listenerCount[eventName]-=listenerCounts[eventName]}function deactivateScope(s,depth){return depth=depth||0,s&&!isActive(s)?(depth||s.$emit(exports.datagrid.events.ON_BEFORE_ROW_DEACTIVATE),s.$$$watchers=s.$$watchers,s.$$watchers=[],depth||(s.$$$listenerCount=s.$$listenerCount,s.$$listenerCount=angular.copy(s.$$$listenerCount),subtractEvents(s,s.$$$listenerCount)),!0):!1}function activateScope(s,depth){return depth=depth||0,s&&s.$$$watchers?(s.$$watchers=s.$$$watchers,s.$$$watchers=null,depth||(addEvents(s,s.$$$listenerCount),s.$$$listenerCount=null),depth||s.$emit(exports.datagrid.events.ON_AFTER_ROW_ACTIVATE),!0):!(!s||s.$$$watchers)}function isActive(index){var s=scopes[index];return!(!s||s.$$$watchers)}function getOffsetIndex(offset){var est=Math.floor(offset/inst.templateModel.averageTemplateHeight()),i=0,len=inst.rowsLength;if(!offset||inst.rowsLength<2)return i;for(rowOffsets[est]&&rowOffsets[est]<=offset&&(i=est);len>i;){if(rowOffsets[i]<=offset&&rowOffsets[i+1]>offset)return i;i+=1}return i}function getStartingIndex(){values.dirty&&inst.chunkModel.getChunkList()&&inst.chunkModel.getChunkList().height-inst.getViewportHeight()<values.scroll&&(inst.info("Scroll reset because either there is no data or the scroll is taller than there is scroll area"),values.scroll=0);var height=viewHeight,scroll=values.scroll>=0?values.scroll:0,result={startIndex:0,i:0,inc:1,end:inst.rowsLength,visibleScrollStart:scroll+options.cushion,visibleScrollEnd:scroll+height-options.cushion};if(result.startIndex=result.i=getOffsetIndex(scroll),inst.rowsLength&&result.startIndex===result.end)throw new Error(exports.errors.E1002);return result}function updateHeightValues(){for(var contentHeight,height=0,i=0;i<inst.rowsLength;)rowOffsets[i]=height,height+=inst.templateModel.getTemplateHeight(inst.data[i]),i+=1;options.rowHeight=inst.rowsLength?inst.templateModel.getTemplateHeight("default"):0,contentHeight=getContentHeight(),inst.getContent()[0].style.height=contentHeight+"px",inst.log("heights: viewport %s content %s",inst.getViewportHeight(),contentHeight)}function updateRowWatchers(){var lastActiveIndex,s,prevS,loop=getStartingIndex(),offset=40*loop.i,lastActive=[].concat(active);if(!(loop.i<0)){for(inst.dispatch(events.ON_BEFORE_UPDATE_WATCHERS,loop),resetMinMax(),active.length=0,inst.log("	scroll %s visibleScrollStart %s visibleScrollEnd %s",values.scroll,loop.visibleScrollStart,loop.visibleScrollEnd);loop.i<inst.rowsLength&&(prevS=scope.$$childHead?scopes[loop.i-1]:null,offset=getRowOffset(loop.i),offset>=loop.visibleScrollStart&&offset<=loop.visibleScrollEnd&&(s=compileRow(loop.i),void 0===loop.started&&(loop.started=loop.i),updateMinMax(loop.i),activateScope(s)&&(inst.getRowElm(loop.i).attr("status","active"),lastActiveIndex=lastActive.indexOf(loop.i),-1!==lastActiveIndex&&lastActive.splice(lastActiveIndex,1),active.push(loop.i),safeDigest(s),s.$digested=!0)),loop.i+=loop.inc,!(loop.inc>0&&offset>loop.visibleScrollEnd||loop.inc<0&&offset<loop.visibleScrollStart)););if(loop.ended=loop.i-1,inst.rowsLength&&values.activeRange.min<0&&values.activeRange.max<0)throw new Error(exports.errors.E1002);inst.log("	startIndex %s endIndex %s",loop.startIndex,loop.i),deactivateList(lastActive),lastVisibleScrollStart=loop.visibleScrollStart,inst.log("	activated %s",active.join(", ")),updateLinks(),inst.dispatch(events.ON_AFTER_UPDATE_WATCHERS,loop)}}function deactivateList(lastActive){for(var lastActiveIndex,deactivated=[];lastActive.length;)lastActiveIndex=lastActive.pop(),deactivated.push(lastActiveIndex),deactivateScope(scopes[lastActiveIndex]),inst.getRowElm(lastActiveIndex).attr("status","inactive");inst.log("	deactivated %s",deactivated.join(", "))}function updateLinks(){if(active.length){var s,lastIndex=active[active.length-1],i=0,len=active.length;for(scope.$$childHead=scopes[active[0]],scope.$$childTail=scopes[lastIndex];len>i;)s=scopes[active[i]],s.$$prevSibling=scopes[active[i-1]],s.$$nextSibling=scopes[active[i+1]],s.$parent=scope,i+=1}}function resetMinMax(){values.activeRange.min=values.activeRange.max=-1}function updateMinMax(activeIndex){values.activeRange.min=values.activeRange.min<activeIndex&&values.activeRange.min>=0?values.activeRange.min:activeIndex,values.activeRange.max=values.activeRange.max>activeIndex&&values.activeRange.max>=0?values.activeRange.max:activeIndex}function beforeRenderAfterDataChange(){values.dirty&&dispatch(exports.datagrid.events.ON_BEFORE_RENDER_AFTER_DATA_CHANGE)}function afterRenderAfterDataChange(){var tplHeight;values.dirty&&values.activeRange.max>=0&&(values.dirty=!1,tplHeight=getRowElm(values.activeRange.min)[0].offsetHeight,inst.getData().length&&tplHeight!==inst.templateModel.getTemplateHeight(inst.getData()[values.activeRange.min])&&inst.templateModel.updateTemplateHeights(),dispatch(exports.datagrid.events.ON_RENDER_AFTER_DATA_CHANGE))}function readyToRender(){return viewHeight?(waitCount&&inst.info("datagrid has height of %s.",viewHeight),!0):(waitCount+=1,2>waitCount?(inst.info("datagrid is waiting for element to have a height."),flow.add(inst.updateViewportHeight,null,0),flow.add(render)):flow.warn("Datagrid: Unable to determine a height for the datagrid. Cannot render. Exiting."),!1)}function render(){if(inst.log("render"),readyToRender())if(waitCount=0,inst.log("	render %s",state),state===states.BUILDING)buildRows(inst.data);else{if(state!==states.READY)throw new Error(exports.errors.E1001);inst.dispatch(exports.datagrid.events.ON_BEFORE_RENDER),flow.add(beforeRenderAfterDataChange),flow.add(updateRowWatchers),flow.add(afterRenderAfterDataChange,null,0),flow.add(inst.dispatch,[exports.datagrid.events.ON_AFTER_RENDER])}else inst.log("	not ready to render.")}function update(){inst.warn("force update"),onDataChanged(scope.$eval(attr.uxDatagrid),inst.data)}function dirtyCheckData(newVal,oldVal){if(newVal&&oldVal&&newVal.length===oldVal.length){for(var i=0,len=newVal.length;len>i;){if(dirtyCheckItemTemplate(newVal[i],oldVal[i]))return!0;i+=1}return inst.data.length!==inst.normalize(newVal,inst.grouped).length?(inst.log("	dirtyCheckData length is different"),!0):!1}return!0}function dirtyCheckItemTemplate(newItem,oldItem){return inst.templateModel.getTemplate(newItem)!==inst.templateModel.getTemplate(oldItem)?(inst.log("	dirtyCheckData row template changed"),!0):!1}function mapData(newVal){inst.log("	mapData()"),inst.data=inst.setData(newVal,inst.grouped)||[],exports.each(inst.getData(),updateScope)}function updateScope(item,index){var tpl;scopes[index]&&(tpl=inst.templateModel.getTemplate(item),scopes[index][tpl.item]=item)}function onDataChanged(newVal,oldVal){if(inst.log("onDataChanged"),inst.grouped=scope.$eval(attr.grouped),oldVal!==inst.getOriginalData()&&(oldVal=inst.getOriginalData()),inst.options.smartUpdate&&inst.data.length&&!dirtyCheckData(newVal,oldVal))values.dirty=!0,mapData(newVal),render();else{var evt=dispatch(exports.datagrid.events.ON_BEFORE_DATA_CHANGE,newVal,oldVal);evt.defaultPrevented&&evt.newValue&&(newVal=evt.newValue),values.dirty=!0,flow.add(changeData,[newVal,oldVal])}}function changeData(newVal,oldVal){inst.log("	changeData"),dispatch(exports.datagrid.events.ON_BEFORE_RESET),inst.data=inst.setData(newVal,inst.grouped)||[],dispatch(exports.datagrid.events.ON_AFTER_DATA_CHANGE,inst.data,oldVal),reset()}function reset(){inst.info("reset start"),flow.clear(),destroyScopes(),rowOffsets={},active.length=0,scopes.length=0,content.children().unbind(),content.children().remove(),inst.chunkModel.getChunkList()?(inst.chunkModel.reset(inst.data,content,scopes),inst.rowsLength=inst.data.length,updateHeights()):buildRows(inst.data,!0),flow.add(inst.info,["reset complete"]),flow.add(dispatch,[exports.datagrid.events.ON_AFTER_RESET],0)}function forceRenderScope(index){var s=scopes[index];!s&&index>=0&&index<inst.rowsLength&&(s=compileRow(index)),s&&!scope.$$phase&&(activateScope(s),s.$digest(),deactivateScope(s),s.$digested=!0)}function onRowTemplateChange(evt,item,oldTemplate,newTemplate,classes){var replaceEl,index=inst.getNormalizedIndex(item),el=getRowElm(index),s=el.hasClass(options.uncompiledClass)?compileRow(index):el.scope();if(s!==scope){for(replaceEl=angular.element(inst.templateModel.getTemplateByName(newTemplate).template),replaceEl.addClass(options.uncompiledClass);classes&&classes.length;)replaceEl.addClass(classes.shift());el.parent()[0].insertBefore(replaceEl[0],el[0]),s.$destroy(),el.remove(),scopes[index]=null,updateHeights(index)}}function updateHeights(rowIndex){flow.add(updateViewportHeight),flow.add(inst.chunkModel.updateAllChunkHeights,[rowIndex]),flow.add(updateHeightValues,0),flow.add(updateViewportHeight),flow.add(function(){var maxScrollHeight=inst.getContentHeight()-inst.getViewportHeight();values.scroll>maxScrollHeight&&(values.scroll=maxScrollHeight)}),flow.add(inst.dispatch,[exports.datagrid.events.ON_AFTER_HEIGHTS_UPDATED]),flow.add(render),flow.add(inst.dispatch,[exports.datagrid.events.ON_AFTER_HEIGHTS_UPDATED_RENDER])}function isLogEvent(evt){return-1!==logEvents.indexOf(evt)}function dispatch(event){return!isLogEvent(event)&&options.debug&&eventLogger.log("$emit %s",event),scope.$emit.apply(scope,arguments)}function forceGarbageCollection(){clearInterval(gcIntv),inst.shuttingDown||(gcIntv=setTimeout(function(){if(inst){inst.info("GC");var a,i,total=524288;for(i=0;total>i;i+=1)a=.5}},1e3))}function destroyScopes(){var lastScope,nextScope,i=0;each(scopes,function(s,index){if(s){for(s.$$prevSibling=lastScope||void 0,i=index;!nextScope&&i<inst.rowsLength;)i+=1,nextScope=scopes[i]||void 0;activateScope(s),lastScope=s,s.$destroy()}}),scope.$$childHead=void 0,scope.$$childTail=void 0,scopes.length=0}function destroy(){for(inst.shuttingDown=!0,getContent()[0].style.display="none",scope.datagrid=null,inst.log("destroying grid"),window.removeEventListener("resize",onResize),clearTimeout(values.scrollingStopIntv),flow.destroy(),inst.flow=void 0,flow=null;unwatchers.length;)unwatchers.pop()();inst.destroyLogger();for(var i in inst)inst[i]&&inst[i].hasOwnProperty("destroy")&&(inst[i].destroy(),inst[i]=null);destroyScopes(),element.remove(),delete scope.$parent[inst.name],rowOffsets=null,inst=null,scope=null,element=null,attr=null,unwatchers=null,content=null,active.length=0,active=null,scopes.length=0,scopes=null,values=null,states=null,events=null,options=null,values=null,logEvents=null,$compile=null}var flow,content,oldContent,options,gcIntv,waitCount=0,changeWatcherSet=!1,unwatchers=[],scopes=[],active=[],lastVisibleScrollStart=0,rowOffsets={},viewHeight=0,states=exports.datagrid.states,events=exports.datagrid.events,state=states.BUILDING,values={dirty:!1,scroll:0,speed:0,absSpeed:0,scrollPercent:0,touchDown:!1,scrollingStopIntv:null,activeRange:{min:0,max:0}},logEvents=[exports.datagrid.events.LOG,exports.datagrid.events.INFO,exports.datagrid.events.WARN,exports.datagrid.events.ERROR],inst={},eventLogger={},startupComplete=!1;return exports.logWrapper("datagrid event",inst,"grey",dispatch),exports.logWrapper("datagrid",inst,"green",dispatch),exports.logWrapper("events",eventLogger,"light",dispatch),scope.datagrid=inst,setupExports(),inst}function ChunkArray(detachDom){this.uid=ChunkArray.uid++,this.enabled=!0,this.min=0,this.max=0,this.templateStart="",this.templateStartWithPos="",this.templateEnd="",this.parent=null,this.mode=detachDom?ChunkArray.DETACHED:ChunkArray.ATTACHED,this.detachDom=detachDom,this.index=0}exports.errors={E1000:"E1000",E1001:"E1001",E1002:"E1002",E1101:"E1101",E1102:"E1102"};var module,isIOS=!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g);try{module=angular.module("ux",["ng"])}catch(e){module=angular.module("ux")}exports.datagrid={isIOS:isIOS,states:{BUILDING:"datagrid:building",READY:"datagrid:ready"},events:{ON_INIT:"datagrid:onInit",ON_LISTENERS_READY:"datagrid:onListenersReady",ON_READY:"datagrid:onReady",ON_STARTUP_COMPLETE:"datagrid:onStartupComplete",ON_BEFORE_RENDER:"datagrid:onBeforeRender",ON_AFTER_RENDER:"datagrid:onAfterRender",ON_BEFORE_UPDATE_WATCHERS:"datagrid:onBeforeUpdateWatchers",ON_AFTER_UPDATE_WATCHERS:"datagrid:onAfterUpdateWatchers",ON_BEFORE_DATA_CHANGE:"datagrid:onBeforeDataChange",ON_AFTER_DATA_CHANGE:"datagrid:onAfterDataChange",ON_BEFORE_RENDER_AFTER_DATA_CHANGE:"datagrid:onBeforeRenderAfterDataChange",ON_RENDER_AFTER_DATA_CHANGE:"datagrid:onRenderAfterDataChange",ON_ROW_TEMPLATE_CHANGE:"datagrid:onRowTemplateChange",ON_SCROLL:"datagrid:onScroll",ON_BEFORE_RESET:"datagrid:onBeforeReset",ON_AFTER_RESET:"datagrid:onAfterReset",ON_AFTER_HEIGHTS_UPDATED:"datagrid:onAfterHeightsUpdated",ON_AFTER_HEIGHTS_UPDATED_RENDER:"datagrid:onAfterHeightsUpdatedRender",ON_BEFORE_ROW_DEACTIVATE:"datagrid:onBeforeRowDeactivate",ON_AFTER_ROW_ACTIVATE:"datagrid:onAFterRowActivate",ON_ROW_COMPILE:"datagrid:onRowCompile",ON_SCROLL_TO_TOP:"datagrid:onScrollToTop",ON_SCROLL_TO_BOTTOM:"datagrid:onScrollToBottom",RESIZE:"datagrid:resize",UPDATE:"datagrid:update",SCROLL_TO_INDEX:"datagrid:scrollToIndex",SCROLL_TO_ITEM:"datagrid:scrollToItem",SCROLL_INTO_VIEW:"datagrid:scrollIntoView",LOG:"datagrid:log",INFO:"datagrid:info",WARN:"datagrid:warn",ERROR:"datagrid:error"},options:{async:!0,updateDelay:100,creepRender:{enable:!0},creepStartDelay:1e3,cushion:-100,chunks:{detachDom:null,size:50,chunkClass:"datagrid-chunk",chunkDisabledClass:"datagrid-chunk-disabled",chunkReadyClass:"datagrid-chunk-ready"},scrollModel:{speed:5,manual:!0,simulateClick:!isIOS},compiledClass:"compiled",uncompiledClass:"uncompiled",contentClass:"datagrid-content",rowClass:"datagrid-row",renderThreshold:1,renderThresholdWait:50,renderWhileScrolling:!1,creepLimit:500,smartUpdate:!0},coreAddons:[]},module.factory("gridAddons",["$injector",function($injector){function applyAddons(addons,instance){for(var result,addon,i=0,len=addons.length;len>i;){if(result=$injector.get(addons[i]),"function"!=typeof result)throw new Error("Addons expect a function to pass the grid instance to.");addon=$injector.invoke(result,instance,{inst:instance}),i+=1}}return function(instance,addons){addons=addons instanceof Array?addons:addons&&addons.replace(/,/g," ").replace(/\s+/g," ").split(" ")||[],instance.addons&&(addons=instance.addons=instance.addons.concat(addons)),applyAddons(addons,instance)}}]),exports.css=function(){function createCustomStyleSheet(name){return getCustomSheet(name)||(customStyleSheets[name]=createStyleSheet(name)),getCustomSheet(name)}function getCustomSheet(name){return customStyleSheets[name]}function createStyleSheet(name){if(document.styleSheets&&0!==document.getElementsByTagName(cnst.head).length){var styleSheet,mediaType,i,media;if(document.styleSheets.length>0)for(i=0;i<document.styleSheets.length&&(document.styleSheets[i].disabled||(media=document.styleSheets[i].media,mediaType=typeof media,mediaType===cnst.string?(""===media||-1!==media.indexOf(cnst.screen))&&(styleSheet=document.styleSheets[i]):mediaType===cnst.object&&(""===media.mediaText||-1!==media.mediaText.indexOf(cnst.screen))&&(styleSheet=document.styleSheets[i]),"undefined"==typeof styleSheet));i++);var styleSheetElement=document.createElement("style");for(styleSheetElement.type="text/css",styleSheetElement.title=name,document.getElementsByTagName(cnst.head)[0].appendChild(styleSheetElement),i=0;i<document.styleSheets.length;i++)document.styleSheets[i].disabled||(styleSheet=document.styleSheets[i]);return{name:name,styleSheet:styleSheet}}}function createClass(sheetName,selector,style){var i,sheet=getCustomSheet(sheetName)||createCustomStyleSheet(sheetName),styleSheet=sheet.styleSheet;if(styleSheet.addRule){for(i=0;i<styleSheet.rules.length;i++)if(styleSheet.rules[i].selectorText&&styleSheet.rules[i].selectorText.toLowerCase()===selector.toLowerCase())return styleSheet.rules[i].style.cssText=style,void 0;if(styleSheet.addRule(selector,style),styleSheet.rules[styleSheet.rules.length-1].cssText===selector+" { }")throw new Error("CSS failed to write")}else if(styleSheet.insertRule){for(i=0;i<styleSheet.cssRules.length;i++)if(styleSheet.cssRules[i].selectorText&&styleSheet.cssRules[i].selectorText.toLowerCase()===selector.toLowerCase())return styleSheet.cssRules[i].style.cssText=style,void 0;styleSheet.insertRule(selector+"{"+style+"}",0)}}function getSelector(selector){var i,ilen,sheet,classes,result;if(-1!==selector.indexOf("{")||-1!==selector.indexOf("}"))return null;if(cache[selector])return cache[selector];for(i=0,ilen=document.styleSheets.length;ilen>i;i+=1)if(sheet=document.styleSheets[i],classes=sheet.rules||sheet.cssRules,result=getRules(classes,selector))return result;return null}function getRules(classes,selector){var j,jlen,cls,result;if(classes)for(j=0,jlen=classes.length;jlen>j;j+=1){if(cls=classes[j],cls.cssRules&&(result=getRules(cls.cssRules,selector)))return result;if(cls.selectorText){var expression="(\b)*"+selector.replace(".","\\.")+"([^-a-zA-Z0-9]|,|$)",matches=cls.selectorText.match(expression);if(matches&&-1!==matches.indexOf(selector))return cache[selector]=cls.style,cls.style}}return null}function getCSSValue(selector,property){var cls=getSelector(selector);return cls&&void 0!==cls[property]?cls[property]:null}function setCSSValue(selector,property,value){var cls=getSelector(selector);cls[property]=value}var customStyleSheets={},cache={},cnst={head:"head",screen:"screen",string:"string",object:"object"};return{createdStyleSheets:[],createStyleSheet:createStyleSheet,createClass:createClass,getCSSValue:getCSSValue,setCSSValue:setCSSValue,getSelector:getSelector}}(),exports.each=each,exports.filter=filter,exports.dispatcher=dispatcher,exports.extend=extend,function(){"use strict";var c=0;exports.uid=function(){c+=1;for(var str=c.toString(36).toUpperCase();str.length<6;)str="0"+str;return str}}(),exports.util=exports.util||{},exports.util.array=exports.util.array||{},exports.util.array.toArray=toArray,exports.util.array.sort=sort,exports.logWrapper=function(name,instance,theme,dispatch){return theme=theme||"black",dispatch=dispatch||instance.dispatch||function(){},instance.$logName=name,instance.log=instance.info=instance.warn=instance.error=function(){},instance.log=function(){var args=[exports.datagrid.events.LOG,name,theme].concat(exports.util.array.toArray(arguments));dispatch.apply(instance,args)},instance.info=function(){var args=[exports.datagrid.events.INFO,name,theme].concat(exports.util.array.toArray(arguments));dispatch.apply(instance,args)
},instance.warn=function(){var args=[exports.datagrid.events.WARN,name,theme].concat(exports.util.array.toArray(arguments));dispatch.apply(instance,args)},instance.error=function(){var args=[exports.datagrid.events.ERROR,name,theme].concat(exports.util.array.toArray(arguments));dispatch.apply(instance,args)},instance.destroyLogger=function(){instance.logger&&(instance.log("destroy"),instance.logger.destroy(),instance.logger=null)},instance},exports.datagrid.Flow=Flow,module.directive("uxDatagrid",["$compile","gridAddons",function($compile,gridAddons){return{restrict:"AE",scope:!0,link:{pre:function(scope,element,attr){var inst=new Datagrid(scope,element,attr,$compile);each(exports.datagrid.coreAddons,function(method){method.apply(inst,[inst])}),gridAddons(inst,attr.addons)},post:function(scope){scope.datagrid.start()}}}}]),exports.datagrid.coreAddons.chunkModel=function(inst){function getChunkList(){return _list}function chunkList(list,size,templateStart,templateEnd){for(var childAry,item,i=0,len=list.length,result=new ChunkArray(inst.options.chunks.detachDom);len>i;)item=list[i],i%size===0&&(childAry&&childAry.updateHeight(inst.templateModel,_rows),childAry=new ChunkArray(inst.options.chunks.detachDom),childAry.min=item.min||i,childAry.templateModel=inst.templateModel,childAry.templateStart=templateStart,childAry.templateEnd=templateEnd,childAry.parent=result,childAry.index=result.length,result.push(childAry)),item instanceof ChunkArray&&(item.parent=childAry,item.index=childAry.length),childAry.push(item),childAry.max=item.max||i,i+=1;return childAry&&childAry.updateHeight(inst.templateModel,_rows),result.min||(result.min=result[0]?result[0].min:0,result.max=result[result.length-1]?result[result.length-1].max:0,result.templateStart=templateStart,result.templateEnd=templateEnd,result.updateHeight(inst.templateModel,_rows),result.dirtyHeight=!1),result.length>size?chunkList(result,size,templateStart,templateEnd):result}function updateAllChunkHeights(rowIndex){var indexes,ary;void 0===rowIndex||inst.options.chunks.detachDom?_list&&(_list.forceHeightReCalc(inst.templateModel,_rows),_list.updateHeight(inst.templateModel,_rows,1),_list.detachDom&&_list.updateDomHeight(1)):(indexes=getRowIndexes(rowIndex,_list),ary=getArrayFromIndexes(indexes,_list),ary.updateHeight(inst.templateModel,_rows,-1,!0))}function getArrayFromIndexes(indexes,ary){for(var index;indexes.length;)index=indexes.shift(),ary[index]instanceof ChunkArray&&(ary=ary[index]);return ary}function chunkDom(list,size,templateStart,templateEnd,el){return result.log("chunkDom"),_el=el,_chunkSize=size,_rows=list,_templateStartCache=templateStart,_templateEndCache=templateEnd,_list=chunkList(list,size,templateStart,templateEnd),updateDom(_list),_list.updateDomHeight(1),el}function getRowIndexes(rowIndex,chunkList,indexes){var chunk,i=0,len=chunkList.length;for(indexes=indexes||[];len>i;){if(chunk=chunkList[i],!(chunk instanceof ChunkArray)){indexes.push(rowIndex%_chunkSize);break}if(rowIndex>=chunk.min&&rowIndex<=chunk.max){indexes.push(i),getRowIndexes(rowIndex,chunk,indexes);break}i+=1}return indexes}function getRow(rowIndex){var indexes=getRowIndexes(rowIndex,_list),el=buildDomByIndexes(indexes);return el&&el.length&&void 0===el.attr("row-id")&&el.attr("row-id",rowIndex),el}function getItemByIndexes(indexes){for(var indxs=indexes.slice(0),ca=_list;indxs.length;)ca=ca[indxs.shift()];return ca}function getDomRowByIndexes(indexes,unrendered){for(var index,i=0,indxs=indexes.slice(0),ca=_list,el=_el;i<indxs.length;)index=indxs.shift(),(!ca.rendered&&unrendered||shouldRecompileDecompiledRows(ca))&&(unrendered(el,ca),updateDom(ca)),indxs.length||checkAllCompiled(ca),ca=ca[index],el=ca.rendered||angular.element(el.children()[index]);return el}function shouldRecompileDecompiledRows(ca){var recompile=!ca.hasChildChunks()&&ca.length&&ca.rendered&&ca.rendered.children().length!==ca.length;return recompile&&result.info("recompile chunk %s",ca.getId()),recompile}function unrendered(el,ca){var children,iLen,i=0;if(el.html(ca.getChildrenStr()),children=el.children(),ca.rendered=el,ca.hasChildChunks())for(iLen=children.length;iLen>i;)ca[i].dom=children[i],i+=1;ca.detachDom&&ca.dirtyHeight&&ca.updateDomHeight(),exports.each(children,computeStyles),ca.hasChildChunks()?-1!==children[0].className.indexOf(inst.options.chunks.chunkClass)&&children.addClass(inst.options.chunks.chunkReadyClass):ca.rendered.hasClass(inst.options.chunks.chunkReadyClass)||ca.rendered.addClass(inst.options.chunks.chunkReadyClass)}function buildDomByIndexes(indexes){return getDomRowByIndexes(indexes,unrendered)}function computeStyles(elm){if(elm){var style=window.getComputedStyle(elm);if(style)return style.getPropertyValue("top")}}function checkAllCompiled(ca){return ca.compiled||(ca.compiled=isCompiled(ca),ca.compiled&&(ca.parent&&checkAllCompiled(ca.parent),inst.flow.add(disableNonVisibleChunks))),ca.compiled}function isCompiled(ca){var min,max;if(ca[0]instanceof ChunkArray){for(min=0,max=ca.length;max>min;){if(!ca[min].compiled)return!1;min+=1}return!0}for(min=ca.min,max=ca.max;max>min;){if(!inst.isCompiled(min))return!1;min+=1}return!0}function updateDom(ca){ca.updateDom(inst.options.chunks.chunkDisabledClass)}function reset(newList,content){result.log("reset"),_cachedDomRows.length=0,newList=newList||[],_list&&(_list.destroy(),_list=null,_el=null,_rows=null),chunkDom(newList,_chunkSize,_templateStartCache,_templateEndCache,content)}function disableNonVisibleChunks(){var r=inst.values.activeRange,o=inst.options.chunks;_list.enableRange(r.min,r.max,o.chunkDisabledClass),o.detachDom&&updateDom(_list)}function destroy(){reset(),_list=null,_rows=null,_chunkSize=null,_el=null,_templateStartCache=null,_templateEndCache=null,_cachedDomRows.length=0,_cachedDomRows=null,inst.chunkModel=null,result.destroyLogger(),result=null,inst=null}var _list,_rows,_chunkSize,_el,_templateStartCache,_templateEndCache,result=exports.logWrapper("chunkModel",{},"purple",inst.dispatch),_cachedDomRows=[];return inst.flow.unique(updateDom),result.chunkDom=chunkDom,result.getChunkList=getChunkList,result.getRowIndexes=function(rowIndex){return getRowIndexes(rowIndex,_list)},result.getItemByIndexes=getItemByIndexes,result.getRow=getRow,result.reset=reset,result.updateAllChunkHeights=updateAllChunkHeights,result.destroy=destroy,inst.scope.$on(exports.datagrid.events.ON_AFTER_UPDATE_WATCHERS,disableNonVisibleChunks),dispatcher(result),inst.chunkModel=result,result},exports.datagrid.coreAddons.push(exports.datagrid.coreAddons.chunkModel),ChunkArray.uid=0,ChunkArray.DETACHED="chunkArray:detached",ChunkArray.ATTACHED="chunkArray:attached",ChunkArray.prototype=[],ChunkArray.prototype.getStub=function(str){return this.templateStartWithPos||this.createDomTemplates(),this.templateStartWithPos+str+this.templateEnd},ChunkArray.prototype.inRange=function(value){return value>=this.min&&value<=this.max},ChunkArray.prototype.rangeOverlap=function(min,max,cushion){var overlap=!1;for(cushion=cushion>0?cushion:0,min-=cushion,max+=cushion;max>min;){if(this.inRange(min)){overlap=!0;break}min+=1}return overlap},ChunkArray.prototype.each=function(method,args){for(var i=0,len=this.length;len>i;)method.apply(this[i],args),i+=1},ChunkArray.prototype.getChildrenStr=function(deep){for(var i=0,len=this.length,str="",ca=this;len>i;)str+=ca[i]instanceof ChunkArray?ca[i].getStub(deep?ca[i].getChildrenStr(deep):""):this.templateModel.getTemplate(ca[i]).template,i+=1;return str},ChunkArray.prototype.updateHeight=function(templateModel,_rows,recurse,updateDomHeight){var len,i=0,height=0;if(this[0]instanceof ChunkArray)for(len=this.length;len>i;)1===recurse&&this[i].updateHeight(templateModel,_rows,recurse,updateDomHeight),height+=this[i].height,i+=1;else height=templateModel.getHeight(_rows,this.min,this.max);this.height!==height&&(this.dirtyHeight=!0,this.height=height),-1==recurse&&this.dirtyHeight&&this.parent&&this.parent.updateHeight(templateModel,_rows,recurse,updateDomHeight),updateDomHeight&&this.dirtyHeight&&this.updateDomHeight()},ChunkArray.prototype.getPreviousSibling=function(){var prevSibling,prevIndex;return this.parent&&(prevIndex=this.index-1,prevSibling=this.parent[prevIndex],prevSibling&&prevSibling.index===this.index-1||this.parent.parent&&(prevSibling=this.parent.getPreviousSibling(),prevSibling&&(prevSibling=prevSibling.last()))),prevSibling},ChunkArray.prototype.getNextSibling=function(){var nextSibling,nextIndex;return this.parent&&(nextIndex=this.index+1,nextSibling=this.parent[nextIndex],nextSibling&&nextSibling.index===this.index+1||this.parent.parent&&(nextSibling=this.parent.getNextSibling(),nextSibling&&(nextSibling=nextSibling.first()))),nextSibling},ChunkArray.prototype.first=function(){return this[0]},ChunkArray.prototype.last=function(){return this[this.length-1]},ChunkArray.prototype.calculateTop=function(){var prevSibling,top=0;return this.index&&this.parent&&(prevSibling=this.getPreviousSibling(),prevSibling&&(top=prevSibling.top+prevSibling.height)),this.top=top,this.top},ChunkArray.prototype.forceHeightReCalc=function(templateModel,_rows){var len,i=0,height=0;if(this[0]instanceof ChunkArray)for(len=this.length;len>i;)height+=this[i].forceHeightReCalc(templateModel,_rows),i+=1;else height=templateModel.getHeight(_rows,this.min,this.max);return this.height!==height&&(this.height=height,this.detachDom?this.dirtySiblings():this.setDirtyHeight()),this.height},ChunkArray.prototype.setDirtyHeight=function(){for(var p=this;p;)p.dirtyHeight=!0,p=p.parent},ChunkArray.prototype.dirtySiblings=function(){if(this.dirtyHeight=!0,this.parent){for(var i=0,iLen=this.length;iLen>i;)this[i].dirtyHeight=!0,i+=1;this.parent.dirtySiblings()}},ChunkArray.prototype.getId=function(){if(this._index!==this.index||!this._id){var p=this,s="";for(this._index=this.index;p;)s="."+p.index+s,p=p.parent;this._id=s.substr(1,s.length)}return this._id},ChunkArray.prototype.hasChildChunks=function(){return this._hasChildChunks||(this._hasChildChunks=this.first()instanceof ChunkArray),this._hasChildChunks},ChunkArray.prototype.enableRange=function(min,max,disabledClass){this.rangeOverlap(min,max,this.detachDom)?this.enable(disabledClass):this.disable(disabledClass),this.hasChildChunks()&&this.each(this.enableRange,[min,max,disabledClass])},ChunkArray.prototype.enable=function(disabledClass){this.enabled||(this.enabled=!0,this.updateDom(disabledClass),this.parent&&this.parent.enable(disabledClass))},ChunkArray.prototype.disable=function(disabledClass){var len,i=0;if(this.compiled){if(this.hasChildChunks())for(len=this.length;len>i;)this[i].disable(disabledClass),i+=1;this.enabled&&(this.enabled=!1,this.updateDom(disabledClass))}},ChunkArray.prototype.updateDom=function(disabledClass){this.rendered&&(this.compiled&&!this.rendered.attr("compiled")&&this.rendered.attr("compiled",!0),this.detachDom?this.enabled?this.detached&&(this.detached=!1,this.parent.rendered.append(this.rendered)):this.enabled||this.detached||this.parent&&this.parent.compiled&&this.rendered.parent().length&&(this.detached=!0,this.rendered.remove(void 0,!0)):(this.rendered.attr("enabled",this.enabled),this.enabled?(this.rendered.removeAttr("disabled"),this.rendered.removeAttr("read-only"),this.rendered.removeClass(disabledClass)):(this.rendered.attr("disabled","disabled"),this.rendered.attr("read-only",!0),this.rendered.addClass(disabledClass))),this.each(this.updateDom,[disabledClass]))},ChunkArray.prototype.updateDomHeight=function(recursiveDirection){var dom=this.rendered&&this.rendered[0]||this.dom;dom?(this.dirtyHeight=!1,this.mode===ChunkArray.DETACHED&&(this.calculateTop(),dom.style.top=this.top+"px"),dom.style.height=this.height+"px"):this.createDomTemplates(),-1===recursiveDirection&&this.parent?this.parent.updateDomHeight(recursiveDirection):recursiveDirection&&this.hasChildChunks()&&this.each(this.updateDomHeight,[recursiveDirection])},ChunkArray.prototype.createDomTemplates=function(){if(!this.templateReady){var str=this.templateStart.substr(0,this.templateStart.length-1)+' style="';this.mode===ChunkArray.DETACHED&&(this.calculateTop(),str+="position:absolute;top:"+this.top+"px;left:0px;"),this.templateStartWithPos=str+"width:100%;height:"+this.height+'px;" chunk-id="'+this.getId()+'" range="'+this.min+":"+this.max+'">',this.templateReady=!0}},ChunkArray.prototype.children=function(){var children=[];this.each(function(){children.push(this.rendered)},[])},ChunkArray.prototype.decompile=function(chunkReadyClass){this.hasChildChunks()?this.each("decompile",[chunkReadyClass]):this.rendered&&(this.rendered.children().remove(),this.rendered.removeClass(chunkReadyClass))},ChunkArray.prototype.destroy=function(){for(this.hasChildChunks()&&this.each(this.destroy),this.templateStart="",this.templateEnd="",this.templateModel=null,this.rendered=null,this.dom=null,this.parent=null;this.length;)this.pop();this.length=0},exports.datagrid.events.ON_RENDER_PROGRESS="datagrid:onRenderProgress",exports.datagrid.events.STOP_CREEP="datagrid:stopCreep",exports.datagrid.events.ENABLE_CREEP="datagrid:enableCreep",exports.datagrid.events.DISABLE_CREEP="datagrid:disableCreep",exports.datagrid.coreAddons.creepRenderModel=function(inst){function digest(index){var s=inst.getScope(index);s&&s.$digested||inst.forceRenderScope(index)}function calculatePercent(){var result={count:0};return each(inst.scopes,calculateScopePercent,result),result.count>=inst.rowsLength&&model.disable(),{count:result.count,len:inst.rowsLength}}function calculateScopePercent(s,index,list,result){result.count+=s?1:0}function onInterval(started,ended,force){inst.values.touchDown||(waitingOnReset=!1,time=Date.now()+inst.options.renderThreshold,upIndex=started,downIndex=ended,render(onComplete,force))}function wait(method,time){var args=exports.util.array.toArray(arguments);return args.splice(0,2),inst.options.async?(clearTimeout(waitHandle),waitHandle=setTimeout(function(){method.apply(null,args)},time)):method.apply(this,args),waitHandle}function findUncompiledIndex(index,dir){for(;index>=0&&index<inst.rowsLength&&inst.isCompiled(index);)index+=dir;return index>=0&&index<inst.rowsLength?index:dir>0?inst.rowsLength:-1}function render(complete,force){var now=Date.now();time>now&&hasIndexesLeft()?(upIndex=force?upIndex:findUncompiledIndex(upIndex,-1),upIndex>=0&&(digest(upIndex),force&&(upIndex-=1)),downIndex=force?downIndex:findUncompiledIndex(downIndex,1),downIndex!==inst.rowsLength&&(digest(downIndex),force&&(downIndex+=1)),render(complete,force)):complete()}function onComplete(){if(stop(),hasIndexesLeft()){creepCount+=1,inst.values.touchDown||inst.values.speed||!hasIndexesLeft()||resetInterval(upIndex,downIndex);var percent=calculatePercent();percent!==lastPercent&&inst.dispatch(exports.datagrid.events.ON_RENDER_PROGRESS,percent)}else creepCount=0,model.disable(),lastPercent=1,inst.dispatch(exports.datagrid.events.ON_RENDER_PROGRESS,1)}function hasIndexesLeft(){return!!(upIndex>-1||downIndex<inst.rowsLength)}function stop(){time=0,clearTimeout(intv),clearTimeout(waitHandle),intv=0}function resetInterval(started,ended,waitTime,forceCompileRowRender){stop(),creepCount<inst.options.creepLimit&&(intv=wait(onInterval,waitTime||inst.options.renderThresholdWait,started,ended,forceCompileRowRender))}function renderLater(event,forceCompileRowRender){resetInterval(upIndex,downIndex,inst.options.creepStartDelay,forceCompileRowRender)}function onBeforeRender(){stop()}function onAfterRender(event,loopData,forceCompileRowRender){creepCount=0,upIndex=loopData.started||0,downIndex=loopData.ended||0,renderLater(event,forceCompileRowRender)}function onBeforeReset(event){onBeforeRender(event),inst.options.creepRender&&inst.options.creepRender.enable!==!1&&model.enable()}var waitHandle,waitingOnReset,time,lastPercent,intv=0,creepCount=0,model=exports.logWrapper("creepModel",{},"blue",inst.dispatch),upIndex=0,downIndex=0,unwatchers=[];model.stop=stop,model.destroy=function(){model.disable(),stop(),inst=null,model=null},model.enable=function(){unwatchers.length||(unwatchers.push(inst.scope.$on(exports.datagrid.events.BEFORE_VIRTUAL_SCROLL_START,onBeforeRender)),unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_VIRTUAL_SCROLL_UPDATE,onBeforeRender)),unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_TOUCH_DOWN,onBeforeRender)),unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_SCROLL_START,onBeforeRender)),unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_AFTER_UPDATE_WATCHERS,onAfterRender)))},model.disable=function(){for(stop(),model.info("creep Disabled");unwatchers.length;)unwatchers.pop()()},inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.DISABLE_CREEP,model.disable)),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_BEFORE_RESET,onBeforeReset)),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.STOP_CREEP,stop)),inst.creepRenderModel=model,inst.options.creepRender&&inst.options.creepRender.enable?model.enable():model.disable()},exports.datagrid.coreAddons.push(exports.datagrid.coreAddons.creepRenderModel),exports.datagrid.coreAddons.normalizeModel=function(inst){function findItem(item,index,list,targetItem,indexes){var found;return indexes=indexes.slice(0),indexes.push(index),item===targetItem?indexes:item[inst.grouped]&&item[inst.grouped].length&&(found=ux.each(item[inst.grouped],findItem,targetItem,indexes),found&&found!==item[inst.grouped])?found:void 0}var originalData,normalizedData,result=exports.logWrapper("normalizeModel",{},"grey",inst.dispatch);return inst.normalize=function(data,grouped,normalized){data=data||[];var i=0,len=data.length;for(normalized=normalized||[];len>i;)normalized.push(data[i]),data[i]&&data[i][grouped]&&inst.normalize(data[i][grouped],grouped,normalized),i+=1;return normalized},inst.setData=function(data,grouped){return result.log("setData %s",data),originalData=data,normalizedData=grouped?inst.normalize(data,grouped):data&&data.slice(0)||[]},inst.getData=function(){return normalizedData},inst.getOriginalData=function(){return originalData},inst.getOriginalIndexOfItem=function(item){var indexes=ux.each(originalData,findItem,item,[]);return indexes&&indexes!==originalData?indexes:[]},inst.getNormalizedIndex=function(item,startIndex){for(var i=startIndex||0;i<inst.rowsLength;){if(inst.data[i]===item)return i;i+=1}if(startIndex)for(i=startIndex;i>=0;){if(inst.data[i]===item)return i;i-=1}return-1},result.replace=function(item,index){for(var origItem,lastIndex,indexes=inst.getOriginalIndexOfItem(normalizedData[index]),list=originalData;indexes.length;){if(lastIndex=indexes.shift(),origItem=list[lastIndex],!indexes.length){list[lastIndex]=item;break}inst.grouped&&(list=origItem[inst.grouped])}normalizedData[index]=item},result.destroy=function(){result.destroyLogger(),originalData=null,normalizedData=null,inst.normalizeModel=null,inst=null,result=null},inst.normalizeModel=result,inst},exports.datagrid.coreAddons.push(exports.datagrid.coreAddons.normalizeModel),exports.datagrid.events.ON_SCROLL_START="datagrid:scrollStart",exports.datagrid.events.ON_SCROLL_STOP="datagrid:scrollStop",exports.datagrid.events.ON_TOUCH_DOWN="datagrid:touchDown",exports.datagrid.events.ON_TOUCH_UP="datagrid:touchUp",exports.datagrid.events.ON_TOUCH_MOVE="datagrid:touchMove",exports.datagrid.coreAddons.scrollModel=function(inst){function setupScrolling(){unwatchSetup(),inst.element.css("overflow")&&"visible"!==inst.element.css("overflow")||inst.element.css({overflow:"auto"}),result.log("addScrollListener"),addScrollListener(),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.SCROLL_TO_INDEX,function(event,index){inst.scrollModel.scrollToIndex(index,!0)})),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.SCROLL_TO_ITEM,function(event,item){inst.scrollModel.scrollToItem(item,!0)})),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.SCROLL_INTO_VIEW,function(event,itemOrIndex){inst.scrollModel.scrollIntoView(itemOrIndex,!0)})),addTouchEvents(),setup=!0}function addScrollListener(){result.log("addScrollListener"),hasScrollListener=!0,inst.element[0].addEventListener("scroll",onUpdateScrollHandler)}function onBeforeReset(){inst.options.scrollModel&&inst.options.scrollModel.manual&&(listenerData[1].enabled=!0),hasScrollListener&&(result.removeScrollListener(),hasScrollListener=!1),result.removeTouchEvents()}function onAfterReset(){hasScrollListener||addScrollListener(),addTouchEvents()}function addTouchEvents(){result.log("addTouchEvents");var content=inst.getContent();exports.each(listenerData,function(item){item.enabled&&(result.log("	add %s",item.event),content.bind(item.event,result[item.method]))})}function getTouches(event){return event.touches||event.originalEvent.touches}function onUpdateScrollHandler(event){inst.scrollModel.onUpdateScroll(event)}function flowWaitForStop(){lastRenderTime=Date.now(),inst.scrollModel.onScrollingStop()}function compileRowSiblings(index){inst.data[index-1]&&!inst.isCompiled(index-1)&&inst.forceRenderScope(index-1),inst.data[index+1]&&!inst.isCompiled(index+1)&&inst.forceRenderScope(index+1)}function onAfterHeightsUpdated(){hasScrollListener&&(result.log("onAfterHeightsUpdated force scroll to %s",inst.values.scroll),inst.element[0].scrollTop=inst.values.scroll)}function destroy(){clearTimeout(waitForStopIntv),result.destroyLogger(),unwatchSetup(),setup&&(result.removeScrollListener(),result.removeTouchEvents()),result=null,inst=null}var unwatchSetup,waitForStopIntv,lastScroll,lastRenderTime,startOffsetY,startOffsetX,offsetY,offsetX,startScroll,lastDeltaY,lastDeltaX,startTime,distance,scrollingIntv,result=exports.logWrapper("scrollModel",{},"orange",inst.dispatch),setup=!1,hasScrollListener=!1,bottomOffset=0,speed=0,listenerData=[{event:"touchstart",method:"onTouchStart",enabled:!0},{event:"touchmove",method:"onTouchMove",enabled:!1},{event:"touchend",method:"onTouchEnd",enabled:!0},{event:"touchcancel",method:"onTouchEnd",enabled:!0}];return result.fireOnScroll=function(){inst.values.scroll!==lastScroll&&(lastScroll=inst.values.scroll,inst.dispatch(exports.datagrid.events.ON_SCROLL,inst.values))},result.removeScrollListener=function(){result.log("removeScrollListener"),inst.element[0].removeEventListener("scroll",onUpdateScrollHandler)},result.removeTouchEvents=function(){if(setup){result.log("removeTouchEvents");var content=inst.getContent();exports.each(listenerData,function(item){result.log("	remove %s",item.event),content.unbind(item.event,result[item.method])})}},result.killEvent=function(event){event.preventDefault(),event.stopPropagation&&event.stopPropagation(),event.stopImmediatePropagation&&event.stopImmediatePropagation()},result.onTouchStart=function(event){clearTimeout(scrollingIntv),inst.values.touchDown=!0,offsetY=startOffsetY=getTouches(event)[0].clientY||0,offsetX=startOffsetX=getTouches(event)[0].clientX||0,inst.values.scroll<0?inst.values.scroll=0:inst.values.scroll>bottomOffset&&(inst.values.scroll=bottomOffset),startScroll=inst.values.scroll,lastDeltaY=0,lastDeltaX=0,inst.dispatch(exports.datagrid.events.ON_TOUCH_DOWN,event)},result.onTouchMove=function(event){result.killEvent(event);var y=getTouches(event)[0].clientY,x=getTouches(event)[0].clientX,deltaY=offsetY-y,deltaX=offsetX-x;deltaY!==lastDeltaY&&(result.setScroll(result.capScrollValue(startScroll+deltaY)),speed=deltaY-lastDeltaY,lastDeltaY=deltaY,lastDeltaX=deltaX),inst.dispatch(exports.datagrid.events.ON_TOUCH_MOVE,speed,deltaY,lastDeltaY)},result.onTouchEnd=function(event){inst.values.touchDown=!1,inst.dispatch(exports.datagrid.events.ON_TOUCH_UP,event),listenerData[1].enabled&&(Math.abs(lastDeltaY)<2&&Math.abs(lastDeltaX)<2?result.click(event):(startTime=Date.now(),distance=speed*inst.options.scrollModel.speed,result.scrollSlowDown(!0)));var sTop=inst.element[0].scrollTop;0>sTop||inst.getContentHeight()<inst.getViewportHeight()?inst.element[0].scrollTop=0:sTop>inst.getContentHeight()-inst.getViewportHeight()&&(inst.element[0].scrollTop=inst.getContentHeight()-inst.getViewportHeight())},result.scrollSlowDown=function(wait){clearTimeout(scrollingIntv);var value,change,duration=Math.abs(speed)*inst.options.scrollModel.speed,t=duration-(Date.now()-startTime),prevDistance=distance;distance=result.easeOut(t,distance,speed||0,duration),change=distance-prevDistance,Math.abs(change)<5&&(t=0),t>0&&(value=result.capScrollValue(inst.values.scroll+change),wait||(inst.element[0].scrollTop=value),scrollingIntv=setTimeout(result.scrollSlowDown,20))},result.easeOut=function(t,b,c,d){return-c*(t/=d)*(t-2)+b},result.click=function(e){if(!exports.datagrid.isIOS||inst.options.scrollModel.simulateClick){inst.options.scrollModel.simulateClick&&result.killEvent(e);var ev,target=e.target;/(SELECT|INPUT|TEXTAREA)/i.test(target.tagName)||(ev=document.createEvent("MouseEvents"),ev.initMouseEvent("click",!0,!0,e.view,1,target.screenX,target.screenY,target.clientX,target.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null),ev._constructed=!0,target.dispatchEvent(ev))}},result.getScroll=function(el){return(el||inst.element[0]).scrollTop},result.setScroll=function(value){var unwatch,chunkList=inst.chunkModel.getChunkList();chunkList&&chunkList.height?inst.getContentHeight()-inst.getViewportHeight()>=value&&(inst.element[0].scrollTop=value):unwatch=inst.scope.$on(exports.datagrid.events.ON_AFTER_RENDER,function(){unwatch(),result.setScroll(value)}),inst.values.scroll=value},result.onUpdateScroll=function(event){var val=inst.scrollModel.getScroll(event.target||event.srcElement);inst.values.scroll!==val&&(inst.dispatch(exports.datagrid.events.ON_SCROLL_START,val),inst.values.speed=val-inst.values.scroll,inst.values.absSpeed=Math.abs(inst.values.speed),inst.values.scroll=val,inst.values.scrollPercent=(inst.values.scroll/inst.getContentHeight()*100).toFixed(2)),inst.scrollModel.waitForStop(),result.fireOnScroll()},result.capScrollValue=function(value){var newVal;return inst.getContentHeight()<inst.getViewportHeight()?(inst.log("	CAPPED scroll value from %s to 0",value),value=0):inst.getContentHeight()-value<inst.getViewportHeight()&&(newVal=inst.getContentHeight()-inst.getViewportHeight(),inst.log("	CAPPED scroll value to keep it from scrolling past the bottom. changed %s to %s",value,newVal),value=newVal),value},result.scrollTo=function(value,immediately){value=result.capScrollValue(value),inst.scrollModel.setScroll(value),immediately?inst.scrollModel.onScrollingStop():inst.scrollModel.waitForStop()},result.clearOnScrollingStop=function(){result.onScrollingStop()},result.waitForStop=function(){var forceRender=!1;clearTimeout(waitForStopIntv),result.log("waitForStop scroll = %s",inst.values.scroll),inst.options.renderWhileScrolling&&Date.now()-(inst.options.renderWhileScrolling>0||0)>lastRenderTime&&(forceRender=!0),forceRender||!inst.flow.async&&!inst.values.touchDown?flowWaitForStop():waitForStopIntv=setTimeout(flowWaitForStop,inst.options.updateDelay)},result.onScrollingStop=function(){result.log("onScrollingStop %s",inst.values.scroll),result.checkForEnds(),inst.values.speed=0,inst.values.absSpeed=0,inst.render(),result.fireOnScroll(),inst.dispatch(exports.datagrid.events.ON_SCROLL_STOP,inst.values),result.calculateBottomOffset()},result.scrollToIndex=function(index,immediately){result.log("scrollToIndex");var offset=inst.getRowOffset(index);return inst.scrollModel.scrollTo(offset,immediately),offset},result.scrollToItem=function(item,immediately){result.log("scrollToItem");var index=inst.getNormalizedIndex(item);return-1!==index?inst.scrollModel.scrollToIndex(index,immediately):inst.values.scroll},result.scrollIntoView=function(itemOrIndex,immediately){result.log("scrollIntoView");var rowHeight,viewHeight,index="number"==typeof itemOrIndex?itemOrIndex:inst.getNormalizedIndex(itemOrIndex),offset=inst.getRowOffset(index);return compileRowSiblings(index),offset<inst.values.scroll?(inst.scrollModel.scrollTo(offset,immediately),void 0):(inst.updateViewportHeight(),viewHeight=inst.getViewportHeight(),rowHeight=inst.templateModel.getTemplateHeight(inst.getData()[index]),offset>=inst.values.scroll+viewHeight-rowHeight&&inst.scrollModel.scrollTo(offset-viewHeight+rowHeight,immediately),void 0)},result.scrollToTop=function(immediately){result.log("scrollToTop"),inst.scrollModel.scrollTo(0,immediately)},result.scrollToBottom=function(immediately){result.log("scrollToBottom");var value=inst.getContentHeight()-inst.getViewportHeight();inst.scrollModel.scrollTo(value>=0?value:0,immediately)},result.calculateBottomOffset=function(){if(inst.rowsLength){var i=inst.rowsLength-1;result.bottomOffset=bottomOffset=inst.getRowOffset(i)-inst.getViewportHeight()+inst.getRowHeight(i)}},result.checkForEnds=function(){inst.values.scroll&&inst.values.scroll>=bottomOffset?(console.log("scrollToBottom %s > %s",inst.values.scroll,bottomOffset),inst.dispatch(ux.datagrid.events.ON_SCROLL_TO_BOTTOM,inst.values.speed)):inst.values.scroll<=0&&(console.log("scrollToTop"),inst.dispatch(ux.datagrid.events.ON_SCROLL_TO_TOP,inst.values.speed))},unwatchSetup=inst.scope.$on(exports.datagrid.events.ON_READY,setupScrolling),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_AFTER_HEIGHTS_UPDATED,onAfterHeightsUpdated)),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_BEFORE_RESET,onBeforeReset)),inst.unwatchers.push(inst.scope.$on(exports.datagrid.events.ON_AFTER_RESET,onAfterReset)),inst.unwatchers.push(inst.scope.$on(ux.datagrid.events.ON_RENDER_AFTER_DATA_CHANGE,result.calculateBottomOffset)),result.destroy=destroy,inst.scrollModel=result,inst},exports.datagrid.coreAddons.push(exports.datagrid.coreAddons.scrollModel),exports.datagrid.coreAddons.templateModel=function(inst){"use strict";function trim(str){return str=str.replace(/\n/g,""),str=str.replace(/[\t ]+</g,"<"),str=str.replace(/>[\t ]+</g,"><"),str=str.replace(/>[\t ]+$/g,">")}return inst.templateModel=function(){function getTemplatesKey(){return templatesKey||(templatesKey="$$template_"+inst.uid),templatesKey}function createTemplates(){result.log("createTemplates");var i,scriptTemplates=inst.element[0].getElementsByTagName("script"),len=scriptTemplates.length;if(!len&&!templates.length)throw new Error(exports.errors.E1102);for(i=0;len>i;i+=1)createTemplateFromScriptTemplate(scriptTemplates[i]);for(;scriptTemplates.length;)inst.element[0].removeChild(scriptTemplates[0])}function createTemplateFromScriptTemplate(scriptTemplate){var name=getScriptTemplateAttribute(scriptTemplate,"template-name")||defaultName,base=getScriptTemplateAttribute(scriptTemplate,"template-base")||null,itemName=getScriptTemplateAttribute(scriptTemplate,"template-item");return createTemplate(trim(angular.element(scriptTemplate).html()),name,itemName,base)}function createTemplatesFromData(templateData){exports.each(templateData,function(tpl){createTemplate(tpl.template,tpl.name,tpl.item,tpl.base)})}function createTemplate(template,name,itemName,base){var templateData,originalTemplate=template,wrapper=document.createElement("div");if(wrapper.className="grid-template-wrapper",template=result.prepTemplate(name,template,base),template=angular.element(template)[0],base||(template.className+=" "+inst.options.rowClass+" "+inst.options.uncompiledClass+" {{$status}}"),template.setAttribute("template",name),inst.getContent()[0].appendChild(wrapper),wrapper.appendChild(template),template=trim(wrapper.innerHTML),templateData={name:name,item:itemName,template:template,originalTemplate:originalTemplate,height:wrapper.offsetHeight},result.log("template: %s %o",name,templateData),!templateData.height){if("none"!==inst.element.css("display"))throw inst.element[0].offsetHeight?new Error(exports.errors.E1101):new Error(exports.errors.E1000);result.warn("Datagrid was intialized with a display:'none' value. Templates are unable to calculate heights. Grid will not render correctly.")}return templates[templateData.name]=templateData,templates.push(templateData),inst.getContent()[0].removeChild(wrapper),totalHeight=0,templateData}function prepTemplate(name,templateStr,base){var baseTemplate,str="";
return base?(baseTemplate=result.getTemplateByName(base),str=baseTemplate.originalTemplate,str=str.replace(new RegExp("#{3}"+name+"#{3}","gi"),templateStr)):templateStr.replace(/\#{3}[\w\d\W]+\#{3}/,"")}function getScriptTemplateAttribute(scriptTemplate,attrStr){var node=scriptTemplate.attributes["data-"+attrStr]||scriptTemplate.attributes[attrStr];return node&&node.nodeValue||""}function getTemplates(){return templates}function getTemplateName(el){return el.attr?el.attr("template"):el.getAttribute("template")}function getTemplateByName(name){return templates[name]?templates[name]:templates[defaultName]}function dynamicHeights(){var i,h;for(i in templates)if(templates.hasOwnProperty(i)&&(h=h||templates[i].height,h!==templates[i].height))return!0;return!1}function averageTemplateHeight(){var i=0,len=templates.length;if(!totalHeight)for(;len>i;)totalHeight+=templates[i].height,i+=1;return totalHeight/len}function countTemplates(){return templates.length}function getTemplateHeight(item){var tpl=result.getTemplate(item);return tpl?tpl.height:0}function getHeight(list,startRowIndex,endRowIndex){var i=startRowIndex,height=0;if(!list.length)return 0;for(;endRowIndex>=i;)height+=result.getTemplateHeight(list[i]),i+=1;return height}function setTemplateName(item,templateName){var key=getTemplatesKey();item.hasOwnProperty(key)||-1!==forcedTemplates.indexOf(item)||forcedTemplates.push(item),item[key]=templateName}function setTemplate(itemOrIndex,newTemplateName,classes){result.log("setTemplate %s %s",itemOrIndex,newTemplateName);var item="number"==typeof itemOrIndex?inst.data[itemOrIndex]:itemOrIndex,oldTemplate=result.getTemplate(item).name;result.setTemplateName(item,newTemplateName),inst.dispatch(exports.datagrid.events.ON_ROW_TEMPLATE_CHANGE,item,oldTemplate,newTemplateName,classes)}function updateTemplateHeights(){for(var row,tpl,rowHeight,i=inst.values.activeRange.min,len=inst.values.activeRange.max-i,changed=!1,heightCache={};len>i;)tpl=result.getTemplate(inst.getData()[i]),heightCache[tpl.name]||(row=inst.getRowElm(i),rowHeight=row[0].offsetHeight,rowHeight!==tpl.height&&(tpl.height=rowHeight,changed=!0)),i+=1;changed&&inst.updateHeights()}function clearTemplate(item){delete item[getTemplatesKey()]}function destroy(){exports.each(forcedTemplates,clearTemplate),forcedTemplates.length=0,result.destroyLogger(),result=null,templates.length=0,templates=null,forcedTemplates=null}var totalHeight,templatesKey,templates=[],defaultName="default",result=exports.logWrapper("templateModel",{},"teal",inst.dispatch),forcedTemplates=[];return result.getTemplate=function(data){var tpl=data[getTemplatesKey()]||data._template;return result.getTemplateByName(tpl)},result.defaultName=defaultName,result.prepTemplate=prepTemplate,result.createTemplates=createTemplates,result.createTemplatesFromData=createTemplatesFromData,result.getTemplates=getTemplates,result.getTemplateName=getTemplateName,result.getTemplateByName=getTemplateByName,result.templateCount=countTemplates,result.dynamicHeights=dynamicHeights,result.averageTemplateHeight=averageTemplateHeight,result.getHeight=getHeight,result.getTemplateHeight=getTemplateHeight,result.setTemplate=setTemplate,result.setTemplateName=setTemplateName,result.updateTemplateHeights=updateTemplateHeights,result.getTemplatesKey=getTemplatesKey,result.destroy=destroy,result}(),inst.templateModel},exports.datagrid.coreAddons.push(exports.datagrid.coreAddons.templateModel);
}(this.ux = this.ux || {}, function() {return this;}()));
